<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Papelera de Reportes - AguaConecta</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      background-color: #fefefe;
    }
    .custom-btn {
      background-color: #00796b;
      color: white;
    }
    img {
      width: 100px;
      height: auto;
    }
    iframe {
      border: none;
      width: 100%;
      min-width: 250px;
      height: 200px;
    }
    .table-responsive {
      overflow-x: auto;
    }
  </style>
</head>
<body class="p-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <a href="{{ url_for('admin_routes.panel_reportes') }}" class="btn custom-btn fw-bold">‚Üê Volver al Panel</a>
    <form id="form-eliminar-todos" action="{{ url_for('admin_routes.eliminar_todos_reportes_definitivo') }}" method="POST">
      <button type="button" class="btn btn-danger" onclick="confirmarEliminarTodos()">üóëÔ∏è Eliminar Todos</button>
    </form>
  </div>

  <h1 class="text-danger">Reportes Atendidos</h1>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          Swal.fire({
            icon: 'success',
            title: '√âxito',
            text: '{{ messages[0] }}',
            timer: 3000,
            showConfirmButton: false
          });
        });
      </script>
    {% endif %}
  {% endwith %}

  {% if reportes_eliminados %}
  <div class="table-responsive mt-4">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Ciudadano</th>
          <th>T√≠tulo</th>
          <th>Descripci√≥n</th>
          <th>Ubicaci√≥n</th>
          <th>Mapa</th>
          <th>Fecha</th>
          <th>Imagen</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for reporte in reportes_eliminados %}
        <tr>
          <td>{{ reporte.id }}</td>
          <td>{{ reporte.nombre_ciudadano or 'No disponible' }}</td>
          <td>{{ reporte.titulo }}</td>
          <td>{{ reporte.descripcion }}</td>
          <td>{{ reporte.direccion or 'No disponible' }}</td>
          <td style="min-width: 300px;">
            {% if reporte.ubicacion and ',' in reporte.ubicacion %}
              {% set latlon = reporte.ubicacion.split(',') %}
              {% if latlon|length == 2 %}
                {% set lat = latlon[0]|trim %}
                {% set lon = latlon[1]|trim %}
                <iframe src="https://www.openstreetmap.org/export/embed.html?bbox={{ lon|float - 0.001 }},{{ lat|float - 0.001 }},{{ lon|float + 0.001 }},{{ lat|float + 0.001 }}&layer=mapnik&marker={{ lat }},{{ lon }}"></iframe>
                <div class="d-flex flex-wrap gap-2 mt-2">
                  <button class="btn btn-outline-primary btn-sm" onclick="abrirMapaModal({{ lat }}, {{ lon }})">
                    <i class="bi bi-arrows-fullscreen"></i> Ampliar
                  </button>
                  <a class="btn btn-outline-success btn-sm" target="_blank" href="https://www.google.com/maps/search/?api=1&query={{ lat }},{{ lon }}">
                    <i class="bi bi-geo-alt"></i> Google Maps
                  </a>
                </div>
              {% else %}
                <span>Coordenadas no v√°lidas</span>
              {% endif %}
            {% else %}
              <span>No disponible</span>
            {% endif %}
          </td>
          <td>{{ reporte.fecha }}</td>
          <td>
            {% if reporte.imagen %}
              <img src="{{ url_for('static', filename='uploads/' ~ reporte.imagen) }}" alt="Imagen del reporte">
            {% else %}
              <span>Sin imagen</span>
            {% endif %}
          </td>
          <td>
            <form id="restaurar-{{ reporte.id }}" action="{{ url_for('admin_routes.restaurar_reporte', reporte_id=reporte.id) }}" method="POST"></form>
            <form id="eliminar-{{ reporte.id }}" action="{{ url_for('admin_routes.eliminar_definitivo', reporte_id=reporte.id) }}" method="POST"></form>

            <button class="btn btn-success btn-sm" onclick="confirmarRestaurar({{ reporte.id }})">üîÑ Restaurar</button>
            <button class="btn btn-danger btn-sm mt-1" onclick="confirmarEliminar({{ reporte.id }})">‚ùå Eliminar Definitivamente</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p class="mt-4">No hay reportes eliminados.</p>
  {% endif %}

  <!-- Modal para mapa ampliado -->
  <div class="modal fade" id="mapaModal" tabindex="-1" aria-labelledby="mapaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="mapaModalLabel">Mapa Ampliado</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <iframe id="iframe-mapa-ampliado" src="" width="100%" height="500" frameborder="0" loading="lazy"></iframe>
          <div class="text-end mt-3">
            <a id="btn-google-maps" href="#" class="btn btn-success" target="_blank">
              <i class="bi bi-geo-alt-fill"></i> Ver en Google Maps
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function confirmarRestaurar(id) {
      Swal.fire({
        title: '¬øRestaurar reporte?',
        text: "El reporte volver√° al panel principal.",
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'S√≠, restaurar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          document.getElementById('restaurar-' + id).submit();
        }
      });
    }

    function confirmarEliminar(id) {
      Swal.fire({
        title: '¬øEliminar permanentemente?',
        text: "¬°Esta acci√≥n no se puede deshacer!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          document.getElementById('eliminar-' + id).submit();
        }
      });
    }

    function confirmarEliminarTodos() {
      Swal.fire({
        title: '¬øEliminar TODOS los reportes?',
        text: "Esto eliminar√° todos los reportes eliminados permanentemente.",
        icon: 'error',
        showCancelButton: true,
        confirmButtonText: 'S√≠, eliminar todos',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          document.getElementById('form-eliminar-todos').submit();
        }
      });
    }

    function abrirMapaModal(lat, lon) {
      const iframeSrc = `https://www.openstreetmap.org/export/embed.html?bbox=${lon - 0.005},${lat - 0.005},${lon + 0.005},${lat + 0.005}&layer=mapnik&marker=${lat},${lon}`;
      document.getElementById('iframe-mapa-ampliado').src = iframeSrc;
      document.getElementById('btn-google-maps').href = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
      new bootstrap.Modal(document.getElementById('mapaModal')).show();
    }
  </script>

</body>
</html>
