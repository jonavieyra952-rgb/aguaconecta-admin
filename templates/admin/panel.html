<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Reportes - AguaConecta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      background-color: #f4f9fb;
      font-family: 'Segoe UI', sans-serif;
    }
    .page-header {
      background-color: #00796b;
      color: white;
      padding: 30px 0;
      border-radius: 0 0 15px 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .table-card {
      background-color: #ffffff;
      border: 1px solid #dceef5;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    .custom-btn {
      background-color: #00796b;
      color: white;
    }
    .custom-btn:hover {
      background-color: #005f56;
      color: white;
    }
    iframe {
      border: none;
      width: 100%;
      min-width: 250px;
      height: 200px;
    }
    .estado-confirmado {
      color: green;
      font-size: 0.9em;
      margin-left: 10px;
      display: none;
    }
    .select-estado {
      min-width: 150px;
    }
    img {
      width: 100px;
      height: auto;
    }
  </style>
</head>
<body>
  <div class="container-fluid page-header text-center mb-4">
    <h2><i class="bi bi-clipboard-data-fill me-2"></i>Panel de Reportes</h2>
  </div>

  <div class="container mb-5">
    <div class="mb-4 d-flex justify-content-end gap-2">
      <a href="{{ url_for('admin_routes.dashboard_admin') }}" class="btn custom-btn fw-bold">Volver al Inicio</a>
      <a href="{{ url_for('admin_routes.historial_reportes') }}" class="btn btn-secondary fw-bold">Historial de Reportes</a>
      <a href="{{ url_for('admin_routes.reportes_eliminados') }}" class="btn btn-danger fw-bold">Papelera de Reportes</a>
    </div>
    <div class="mb-3">
  <label for="filtroEstado" class="form-label fw-bold">Filtrar por estado:</label>
  <select id="filtroEstado" class="form-select w-auto d-inline-block">
    <option value="todos">Todos</option>
    <option value="Pendiente">Pendiente</option>
    <option value="En proceso">En proceso</option>
    <option value="Resuelto">Resuelto</option>
  </select>
</div>
<div class="row mb-3">
  <div class="col-md-4">
    <label class="form-label fw-bold">Ordenar por fecha:</label>
    <select id="orden-fecha" class="form-select">
      <option value="recientes">Recientes primero</option>
      <option value="antiguos">Antiguos primero</option>
    </select>
  </div>
</div>
<div class="mb-3">
  <form method="GET" action="{{ url_for('admin_routes.panel_reportes') }}">
    <label for="filtroLugar" class="form-label fw-bold">Filtrar por lugar:</label>
    <select id="filtroLugar" name="lugar" class="form-select w-auto d-inline-block" onchange="this.form.submit()">
      <option value="">Todos</option>
      {% for lugar in lugares %}
        <option value="{{ lugar }}" {% if lugar == lugar_seleccionado %}selected{% endif %}>{{ lugar }}</option>
      {% endfor %}
    </select>
  </form>
</div>



    <div class="table-card">
      <div class="mb-3">
        <button id="btn-actualizar" class="btn custom-btn fw-bold">‚úÖ Actualizar Estados</button>
        <div id="loader" class="mt-2" style="display:none; color:#00796b; font-weight:bold;">‚è≥ Actualizando estados...</div>
      </div>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-success">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      {% if reportes %}
  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle">
      <thead class="text-center" style="background-color:#00796b; color:white;">
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Nombre del Ciudadano</th>
          <th>Tel√©fono</th>
          <th>T√≠tulo</th>
          <th>Descripci√≥n</th>
          <th>Ubicaci√≥n</th>
          <th>Mapa</th>
          <th>Estado</th>
          <th>Fecha</th>
          <th>Imagen</th>
          <th>Atendido por</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for reporte in reportes %}
          <tr>
            <td>{{ reporte.id }}</td>
            <td>{{ reporte.usuario_id }}</td>
            <td>{{ reporte.nombre_ciudadano or 'No disponible' }}</td>
            <td>{{ reporte.telefono_ciudadano or 'No disponible' }}</td>
            <td>{{ reporte.titulo }}</td>
            <td>{{ reporte.descripcion }}</td>
            <td>{{ reporte.direccion or 'No disponible' }}</td>
            <td style="min-width: 300px;">
              {% if reporte.ubicacion and ',' in reporte.ubicacion %}
                {% set latlon = reporte.ubicacion.split(',') %}
                {% if latlon|length == 2 %}
                  {% set lat = latlon[0]|trim %}
                  {% set lon = latlon[1]|trim %}
                  <iframe src="https://www.openstreetmap.org/export/embed.html?bbox={{ lon|float - 0.001 }},{{ lat|float - 0.001 }},{{ lon|float + 0.001 }},{{ lat|float + 0.001 }}&layer=mapnik&marker={{ lat }},{{ lon }}" loading="lazy"></iframe>
                  <div class="d-flex flex-wrap gap-2 mt-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="abrirMapaModal({{ lat }}, {{ lon }})">
                      <i class="bi bi-arrows-fullscreen"></i> Ampliar
                    </button>
                    <a class="btn btn-outline-success btn-sm" target="_blank" href="https://www.google.com/maps/search/?api=1&query={{ lat }},{{ lon }}">
                      <i class="bi bi-geo-alt"></i> Google Maps
                    </a>
                  </div>
                {% else %}
                  <span class="text-danger">Coordenadas mal formateadas</span>
                {% endif %}
              {% else %}
                <span>No disponible</span>
              {% endif %}
            </td>
            <td>
              <select class="form-select select-estado estado-select" data-id="{{ reporte.id }}">
                <option value="Pendiente" {% if reporte.estado == 'Pendiente' %}selected{% endif %}>Pendiente</option>
                <option value="En proceso" {% if reporte.estado == 'En proceso' %}selected{% endif %}>En proceso</option>
                <option value="Resuelto" {% if reporte.estado == 'Resuelto' %}selected{% endif %}>Resuelto</option>
              </select>
              <span class="estado-confirmado" id="confirmacion-{{ reporte.id }}">‚úì actualizado</span>
            </td>
            <td>{{ reporte.fecha }}</td>
            <td>
              {% if reporte.imagen %}
                <div class="text-center">
                  <img src="{{ url_for('static', filename='uploads/' ~ reporte.imagen) }}" alt="Imagen del reporte" class="img-thumbnail reporte-img" style="cursor:pointer;">
                  <div class="mt-2">
                    <a href="{{ url_for('static', filename='uploads/' ~ reporte.imagen) }}" download class="btn btn-outline-primary btn-sm">
                      <i class="bi bi-download"></i> Descargar
                    </a>
                  </div>
                </div>
              {% else %}
                <span>Sin imagen</span>
              {% endif %}
            </td>
            <td>{{ reporte.atendido_por if reporte.atendido_por else 'Sin asignar' }}</td>
            <td>
              {% if reporte.estado == 'Resuelto' %}
                <div class="d-flex flex-column gap-1">
                  <form action="{{ url_for('admin_routes.eliminar_reportes', reporte_id=reporte.id) }}" method="POST" onsubmit="return false;" id="form-eliminar-{{ reporte.id }}">
                    <button type="button" class="btn btn-danger btn-sm" onclick="confirmarEliminar({{ reporte.id }})">üóëÔ∏è Eliminar</button>
                  </form>
                  <form action="{{ url_for('admin_routes.archivar_reporte', reporte_id=reporte.id) }}" method="POST" onsubmit="return false;" id="form-archivar-{{ reporte.id }}">
                    <button type="button" class="btn btn-secondary btn-sm" onclick="confirmarArchivar({{ reporte.id }})">üìÅ Archivar</button>
                  </form>
                  <a href="{{ url_for('admin_routes.descargar_pdf_reporte', reporte_id=reporte.id) }}" class="btn btn-outline-dark btn-sm" target="_blank">
                    üìÑ PDF
                  </a>
                </div>
              {% else %}
                <span>-</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="alert alert-info text-center" role="alert">
    No hay reportes registrados por el momento.
  </div>
{% endif %}


<!-- üîç MODAL de mapa ampliado -->
<div class="modal fade" id="mapaModal" tabindex="-1" aria-labelledby="mapaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mapaModalLabel">Mapa Ampliado</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <iframe id="iframe-mapa-ampliado" src="" width="100%" height="500" frameborder="0" loading="lazy"></iframe>
        <div class="text-end mt-3">
          <a id="btn-google-maps" href="#" class="btn btn-success" target="_blank">
            <i class="bi bi-geo-alt-fill"></i> Ver en Google Maps
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- üñºÔ∏è MODAL para imagen ampliada -->
<div class="modal fade" id="imagenModal" tabindex="-1" aria-labelledby="imagenModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-body p-0">
        <img src="" id="imagenAmpliada" class="img-fluid w-100" alt="Imagen ampliada">
      </div>
    </div>
  </div>
</div>


<script>
function confirmarEliminar(id) {
  Swal.fire({
    title: '¬øEliminar reporte?',
    text: "Este reporte se mover√° a la secci√≥n de reportes eliminados.",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'S√≠, eliminar',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      document.getElementById('form-eliminar-' + id).submit();
    }
  });
}

function confirmarArchivar(id) {
  Swal.fire({
    title: '¬øArchivar reporte?',
    text: "Este reporte se mover√° al historial.",
    icon: 'info',
    showCancelButton: true,
    confirmButtonText: 'S√≠, archivar',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      document.getElementById('form-archivar-' + id).submit();
    }
  });
}

function abrirMapaModal(lat, lon) {
  const iframeSrc = `https://www.openstreetmap.org/export/embed.html?bbox=${lon - 0.005},${lat - 0.005},${lon + 0.005},${lat + 0.005}&layer=mapnik&marker=${lat},${lon}`;
  document.getElementById('iframe-mapa-ampliado').src = iframeSrc;
  document.getElementById('btn-google-maps').href = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
  new bootstrap.Modal(document.getElementById('mapaModal')).show();
}

const estadosModificados = new Map();

document.querySelectorAll('.estado-select').forEach(select => {
  select.addEventListener('change', function () {
    const reporteId = this.getAttribute('data-id');
    const nuevoEstado = this.value;
    estadosModificados.set(reporteId, nuevoEstado);

    const confirmacion = document.getElementById('confirmacion-' + reporteId);
    confirmacion.textContent = '‚úì pendiente de actualizar';
    confirmacion.style.display = 'inline';
  });
});

document.getElementById('btn-actualizar').addEventListener('click', function () {
  if (estadosModificados.size === 0) {
    Swal.fire({
      icon: 'info',
      title: 'Sin cambios',
      text: 'No hay cambios pendientes para actualizar.',
      timer: 3000,
      showConfirmButton: false
    });
    return;
  }

  const loader = document.getElementById('loader');
  loader.style.display = 'block';

  let total = estadosModificados.size;
  let completados = 0;

  estadosModificados.forEach((nuevoEstado, reporteId) => {
    const formData = new URLSearchParams();
    formData.append('reporte_id', reporteId);
    formData.append('nuevo_estado', nuevoEstado);

    fetch('/admin/actualizar-estado', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: formData
    })
    .then(res => {
      completados++;
      if (res.ok) {
        const confirmacion = document.getElementById('confirmacion-' + reporteId);
        confirmacion.textContent = '‚úì actualizado';
        confirmacion.style.display = 'inline';

        if (nuevoEstado === 'Resuelto') {
          const fila = document.querySelector(`.estado-select[data-id="${reporteId}"]`).closest('tr');
          const accionesTd = fila.querySelector('td:last-child');
          accionesTd.innerHTML = `
            <div class="d-flex flex-column gap-1">
              <form action="/admin/eliminar-reporte/${reporteId}" method="POST" onsubmit="return false;" id="form-eliminar-${reporteId}">
                <button type="button" class="btn btn-danger btn-sm" onclick="confirmarEliminar(${reporteId})">üóëÔ∏è Eliminar</button>
              </form>
              <form action="/admin/archivar-reporte/${reporteId}" method="POST" onsubmit="return false;" id="form-archivar-${reporteId}">
                <button type="button" class="btn btn-secondary btn-sm" onclick="confirmarArchivar(${reporteId})">üìÅ Archivar</button>
              </form>
              <a href="/admin/reporte/${reporteId}/pdf" class="btn btn-outline-dark btn-sm" target="_blank">
                üìÑ PDF
              </a>
            </div>`;
        }
      }

      if (completados === total) {
        loader.style.display = 'none';
        estadosModificados.clear();
      }
    })
    .catch(() => {
      completados++;
      Swal.fire('Error', 'Ocurri√≥ un error al actualizar.', 'error');
      if (completados === total) {
        loader.style.display = 'none';
        estadosModificados.clear();
      }
    });
  });
});

// üñºÔ∏è Ampliar imagen en modal
document.addEventListener("DOMContentLoaded", function () {
  const imagenes = document.querySelectorAll('.reporte-img');
  const imagenAmpliada = document.getElementById('imagenAmpliada');

  imagenes.forEach(img => {
    img.addEventListener('click', () => {
      const src = img.getAttribute('src');
      imagenAmpliada.setAttribute('src', src);
      const modal = new bootstrap.Modal(document.getElementById('imagenModal'));
      modal.show();
    });
  });
});
// üéØ Filtro por estado de reporte
document.getElementById('filtroEstado').addEventListener('change', function () {
  const estadoSeleccionado = this.value;
  const filas = document.querySelectorAll('tbody tr');

  filas.forEach(fila => {
    const selectEstado = fila.querySelector('.estado-select');
    if (!selectEstado) return;

    const estadoActual = selectEstado.value;

    if (estadoSeleccionado === 'todos' || estadoActual === estadoSeleccionado) {
      fila.style.display = '';
    } else {
      fila.style.display = 'none';
    }
  });
});
// üîÅ Ordenar por fecha
document.getElementById('orden-fecha').addEventListener('change', function () {
  const orden = this.value;
  const tbody = document.querySelector('table tbody');
  const filas = Array.from(tbody.querySelectorAll('tr'));

  filas.sort((a, b) => {
    const fechaA = new Date(a.querySelector('td:nth-child(10)').textContent.trim());
    const fechaB = new Date(b.querySelector('td:nth-child(10)').textContent.trim());
    return orden === 'recientes' ? fechaB - fechaA : fechaA - fechaB;
  });

  filas.forEach(fila => tbody.appendChild(fila));
});

</script>
</body>
</html>
